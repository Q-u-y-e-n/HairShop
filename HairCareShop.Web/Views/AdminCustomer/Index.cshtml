@model IEnumerable<HairCareShop.Core.Entities.User>

@{
    ViewData["Title"] = "Quản lý Khách hàng";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary fw-bold m-0"><i class="bi bi-people-fill me-2"></i>Danh sách Khách hàng</h3>
        <a asp-action="Create" class="btn btn-success fw-bold shadow-sm">
            <i class="bi bi-person-plus-fill me-1"></i> Thêm khách hàng
        </a>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <form asp-action="Index" method="get">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" name="searchString" class="form-control border-start-0"
                        placeholder="Tìm theo tên, email, sđt..." value="@ViewData["CurrentFilter"]">
                    <button class="btn btn-primary px-4">Tìm kiếm</button>
                </div>
            </form>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4">Khách hàng</th>
                        <th>Liên hệ</th>
                        <th>Lịch sử</th>
                        <th>Trạng thái</th>
                        <th class="text-center" style="width: 150px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        int orderCount = item.Orders?.Count ?? 0;
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">@item.FullName</div>
                                <small class="text-muted">ID: #@item.Id</small>
                            </td>
                            <td>
                                <div><i class="bi bi-envelope me-1"></i> @item.Email</div>
                                <div class="small text-muted"><i class="bi bi-telephone me-1"></i> @(item.PhoneNumber ??
                                                                    "---")</div>
                            </td>
                            <td>
                                <span class="badge bg-info-subtle text-info-emphasis">@orderCount đơn hàng</span>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" onchange="toggleLock(@item.Id)"
                                        @(item.IsLocked ? "" : "checked")>
                                    <label class="form-check-label small" id="lbl-status-@item.Id">
                                        @(item.IsLocked ? "Đang khóa" : "Hoạt động")
                                    </label>
                                </div>
                            </td>
                            <td class="text-center">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info"
                                    title="Lịch sử mua hàng">
                                    <i class="bi bi-clock-history"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary"
                                    title="Sửa thông tin">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="d-inline"
                                    onsubmit="return confirm('Bạn có chắc muốn xóa khách hàng này? Hành động này không thể hoàn tác!');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function toggleLock(id) {
        fetch('/AdminCustomer/ToggleStatus?id=' + id, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    let lbl = document.getElementById('lbl-status-' + id);
                    lbl.innerText = d.isLocked ? "Đang khóa" : "Hoạt động";
                    lbl.className = d.isLocked ? "form-check-label small text-danger" : "form-check-label small text-success";
                } else alert('Lỗi hệ thống');
            });
    }
</script>