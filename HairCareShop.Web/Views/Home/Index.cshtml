@model HairCareShop.Web.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var culture = new System.Globalization.CultureInfo("vi-VN");
}

<div class="container-fluid p-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="font-weight-bold text-dark mb-0">📊 Báo Cáo Kinh Doanh</h2>
            <p class="text-muted">Thống kê chi tiết tháng @Model.SelectedMonth/@Model.SelectedYear</p>
        </div>
        <div class="col-md-6">
            <form method="get" class="form-inline float-right bg-white p-3 rounded shadow-sm">
                <label class="mr-2 font-weight-bold">Chọn thời gian:</label>

                <select name="month" class="form-control mr-2">
                    @for (int m = 1; m <= 12; m++)
                    {
                        if (m == Model.SelectedMonth)
                        {
                            <option value="@m" selected>Tháng @m</option>
                        }
                        else
                        {

                            <option value="@m">Tháng @m</option>
                        }
                    }
                </select>

                <select name="year" class="form-control mr-2">
                    @for (int y = DateTime.Now.Year; y >= 2023; y--)
                    {
                        if (y == Model.SelectedYear)
                        {
                            <option value="@y" selected>@y</option>
                        }
                        else
                        {

                            <option value="@y">@y</option>
                        }
                    }
                </select>

                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-filter"></i> Xem báo cáo
                </button>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small font-weight-bold">Doanh thu tháng</div>
                    <h3 class="font-weight-bold mt-2">@Model.MonthlyRevenue.ToString("C0", culture)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small font-weight-bold">Tổng đơn hàng</div>
                    <h3 class="font-weight-bold mt-2">@Model.TotalOrders đơn</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small font-weight-bold">Giao thành công</div>
                    <h3 class="font-weight-bold mt-2">@Model.SuccessfulOrders đơn</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small font-weight-bold">Đơn hủy</div>
                    <h3 class="font-weight-bold mt-2">@Model.CancelledOrders đơn</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white font-weight-bold">
                    📈 Biểu đồ doanh thu từng ngày (Tháng @Model.SelectedMonth)
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white font-weight-bold">
                    📦 Tỷ lệ trạng thái đơn
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white font-weight-bold text-primary">
            🏆 Top 5 Sản phẩm bán chạy nhất (Tháng @Model.SelectedMonth)
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th>Sản phẩm</th>
                        <th class="text-center">Đã bán</th>
                        <th class="text-right">Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.TopSellingProducts.Count > 0)
                    {
                        @foreach (var item in Model.TopSellingProducts)
                        {
                            <tr>
                                <td class="align-middle">
                                    <img src="@item.ImageUrl"
                                        style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;"
                                        onerror="this.src='/images/no-image.png'" />
                                    <span class="ml-2 font-weight-bold">@item.ProductName</span>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge badge-success p-2">@item.SoldQuantity</span>
                                </td>
                                <td class="text-right align-middle font-weight-bold">
                                    @item.TotalRevenue.ToString("N0") đ
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">Chưa có dữ liệu bán hàng trong tháng này.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Biểu đồ Doanh thu (Line Chart cho từng ngày sẽ đẹp hơn Bar)
    var ctxRev = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRev, {
        type: 'line', // Đổi sang Line để thấy xu hướng ngày
        data: {
            labels: @Html.Raw(Json.Serialize(Model.ChartLabels)),
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: @Html.Raw(Json.Serialize(Model.ChartData)),
                borderColor: '#28a745', // Màu xanh lá
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                pointBackgroundColor: '#28a745',
                fill: true,
                tension: 0.3 // Làm cong đường biểu đồ
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    // 2. Biểu đồ Tròn
    var ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Chờ xác nhận', 'Đang giao', 'Hoàn thành', 'Đã hủy'],
            datasets: [{
                data: [
                    @Model.PendingCount,
                    @Model.ShippingCount,
                    @Model.CompletedCount,
                    @Model.CancelledCount
                ],
                backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545'],
                hoverOffset: 4
            }]
        }
    });
</script>