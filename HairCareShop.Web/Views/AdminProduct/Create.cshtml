@model HairCareShop.Core.Entities.Product

@{
    ViewData["Title"] = "Thêm sản phẩm mới";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary fw-bold"><i class="bi bi-plus-circle"></i> Thêm sản phẩm mới</h4>
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
    </div>

    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div class="row">

            <div class="col-md-8">

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold text-uppercase text-muted small">
                        1. Thông tin chung
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label fw-bold">Tên sản phẩm <span
                                    class="text-danger">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="Ví dụ: Dầu gội Clear Men Bạc Hà"
                                required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryId" class="form-label fw-bold">Danh mục</label>
                                <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Brand" class="form-label fw-bold">Thương hiệu</label>
                                <input asp-for="Brand" class="form-control"
                                    placeholder="Ví dụ: Clear, Dove, L'Oréal..." />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label fw-bold">Mô tả chi tiết</label>
                            <textarea asp-for="Description" class="form-control" rows="3"
                                placeholder="Nhập mô tả sản phẩm, công dụng, thành phần..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-success mb-4">
                    <div class="card-header bg-success text-white fw-bold">
                        <i class="bi bi-box-seam"></i> 2. Nhập lô hàng đầu tiên (Tùy chọn)
                    </div>
                    <div class="card-body bg-light">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> Nếu có sẵn hàng, nhập thông tin bên dưới để tạo Lô hàng
                            (Batch) đầu tiên.
                        </p>

                        <div class="row align-items-end">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-success">Số Thùng/Hộp nhập</label>
                                <input type="number" name="InitialStock" id="inputInitStock"
                                    class="form-control border-success fw-bold" value="0" min="0"
                                    oninput="calculateTotal()" />
                                <small class="text-muted">Nhập số lượng thùng</small>
                            </div>

                            <div class="col-md-8 mb-3">
                                <div class="alert alert-warning m-0 py-2 d-flex align-items-center">
                                    <i class="bi bi-calculator me-2"></i>
                                    <span>Thực nhập vào kho: </span>
                                    <strong id="previewTotal" class="fs-5 text-danger mx-2">0</strong>
                                    <span id="previewUnit" class="fw-bold">Đơn vị</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Mã Lô (Batch)</label>
                                <input type="text" name="BatchCode" class="form-control"
                                    placeholder="Tự động (L-yyyymmdd)..." />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Ngày sản xuất</label>
                                <input type="date" name="ManufacturingDate" class="form-control" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Hạn sử dụng</label>
                                <input type="date" name="ExpiryDate" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-md-4">

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold text-uppercase text-muted small">
                        3. Giá bán & Quy cách
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Price" class="form-label fw-bold">Giá bán lẻ (VNĐ) <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input asp-for="Price" type="number" class="form-control fw-bold text-success"
                                    placeholder="0" required />
                                <span class="input-group-text">đ</span>
                            </div>
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="UnitName" class="form-label fw-bold">Đơn vị tính lẻ <span
                                    class="text-danger">*</span></label>
                            <input asp-for="UnitName" id="inputUnitName" class="form-control" value="Chai" required
                                placeholder="VD: Chai, Hộp" oninput="calculateTotal()" />
                            <small class="text-muted">Đơn vị bán cho khách hàng.</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="UnitsPerBox" class="form-label fw-bold">Quy cách đóng thùng</label>
                            <input asp-for="UnitsPerBox" id="inputPerBox" type="number" class="form-control" value="1"
                                min="1" oninput="calculateTotal()" />
                            <small class="text-muted">1 Thùng = bao nhiêu lẻ?</small>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold text-uppercase text-muted small">
                        4. Hình ảnh đại diện
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3 position-relative">
                            <img id="imgPreview" src="https://via.placeholder.com/300x300?text=Preview+Image"
                                class="img-thumbnail" style="max-height: 250px; width: 100%; object-fit: contain;"
                                alt="Ảnh xem trước" />
                        </div>

                        <input type="file" name="imageFile" class="form-control" accept="image/*"
                            onchange="previewImage(this)" />
                        <small class="text-muted d-block mt-2 text-start">Hỗ trợ: .jpg, .png, .jpeg (Max 2MB)</small>
                    </div>
                </div>

                <div class="mt-4 d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold py-3">
                        <i class="bi bi-save"></i> LƯU SẢN PHẨM
                    </button>
                    <a asp-action="Index" class="btn btn-light text-secondary">Hủy bỏ</a>
                </div>
            </div>

        </div>
    </form>
</div>

@section Scripts {
    <script>
        // 1. Tự động điền ngày hiện tại khi mở trang
        document.addEventListener("DOMContentLoaded", function () {
            let today = new Date().toISOString().split('T')[0];

            let nextYearDate = new Date();
            nextYearDate.setFullYear(nextYearDate.getFullYear() + 1);
            let nextYear = nextYearDate.toISOString().split('T')[0];

            let mfgInput = document.querySelector('input[name="ManufacturingDate"]');
            let expInput = document.querySelector('input[name="ExpiryDate"]');

            if (mfgInput) mfgInput.value = today;
            if (expInput) expInput.value = nextYear;

            // Gọi tính toán lần đầu (để hiện chữ Đơn vị đúng)
            calculateTotal();
        });

        // 2. Hàm xem trước ảnh
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imgPreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. Hàm tính toán tồn kho (Thùng * Quy cách)
        function calculateTotal() {
            // Lấy giá trị
            let boxes = parseInt(document.getElementById('inputInitStock').value) || 0;
            let perBox = parseInt(document.getElementById('inputPerBox').value) || 1;
            let unitName = document.getElementById('inputUnitName').value || 'Đơn vị';

            // Tính toán
            let total = boxes * perBox;

            // Hiển thị kết quả ra thẻ strong và span
            document.getElementById('previewTotal').innerText = total;
            document.getElementById('previewUnit').innerText = unitName;
        }
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}